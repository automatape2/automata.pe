---
interface Props {
    lang: "es" | "en";
}

const { lang } = Astro.props;
---

<div
    id="ai-chat-container"
    class="fixed bottom-4 right-4 sm:bottom-6 sm:right-6 z-50"
>
    <!-- Chat Toggle Button -->
    <button
        id="chat-toggle"
        class="w-14 h-14 sm:w-16 sm:h-16 bg-gradient-to-br from-cyan-500 to-purple-600 rounded-full shadow-[0_0_30px_rgba(6,182,212,0.4)] hover:shadow-[0_0_40px_rgba(6,182,212,0.6)] flex items-center justify-center transition-all duration-300 hover:scale-110 group"
        aria-label="Toggle AI Chat"
    >
        <svg
            id="chat-icon"
            class="w-7 h-7 sm:w-8 sm:h-8 text-white transition-transform duration-300"
            fill="none"
            stroke="currentColor"
            viewBox="0 0 24 24"
        >
            <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M8 10h.01M12 10h.01M16 10h.01M9 16H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-5l-5 5v-5z"
            ></path>
        </svg>
        <svg
            id="close-icon"
            class="w-7 h-7 sm:w-8 sm:h-8 text-white absolute transition-transform duration-300 scale-0"
            fill="none"
            stroke="currentColor"
            viewBox="0 0 24 24"
        >
            <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M6 18L18 6M6 6l12 12"></path>
        </svg>
        <!-- Notification dot -->
        <span
            id="notification-dot"
            class="absolute top-0 right-0 w-4 h-4 bg-red-500 rounded-full border-2 border-slate-900 animate-pulse hidden"
        ></span>
    </button>

    <!-- Chat Window -->
    <div
        id="chat-window"
        class="fixed sm:absolute bottom-0 sm:bottom-20 right-0 left-0 sm:left-auto w-full sm:w-96 h-[100dvh] sm:h-[32rem] bg-slate-900/95 backdrop-blur-xl sm:rounded-2xl shadow-[0_0_50px_rgba(6,182,212,0.3)] border-t sm:border border-slate-700/50 flex flex-col transform scale-0 origin-bottom-right transition-all duration-300 opacity-0"
    >
        <!-- Chat Header -->
        <div
            class="p-3 sm:p-4 border-b border-slate-700/50 bg-gradient-to-r from-cyan-500/10 to-purple-500/10 sm:rounded-t-2xl"
        >
            <div class="flex items-center gap-3">
                <div class="relative">
                    <div
                        class="w-10 h-10 bg-gradient-to-br from-cyan-400 to-purple-600 rounded-full flex items-center justify-center"
                    >
                        <span class="text-xl">ğŸ¤–</span>
                    </div>
                    <span
                        class="absolute bottom-0 right-0 w-3 h-3 bg-green-500 rounded-full border-2 border-slate-900"
                    ></span>
                </div>
                <div class="flex-1">
                    <h3 class="font-semibold text-white">Asistente IA</h3>
                    <p class="text-xs text-slate-400">
                        {lang === "es" ? "En lÃ­nea" : "Online"}
                    </p>
                </div>
                <!-- Close button for mobile -->
                <button
                    id="mobile-close-btn"
                    class="sm:hidden w-8 h-8 flex items-center justify-center rounded-full hover:bg-slate-800/50 transition-colors"
                    aria-label="Close chat"
                >
                    <svg
                        class="w-5 h-5 text-slate-400"
                        fill="none"
                        stroke="currentColor"
                        viewBox="0 0 24 24"
                    >
                        <path
                            stroke-linecap="round"
                            stroke-linejoin="round"
                            stroke-width="2"
                            d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
            </div>
        </div>

        <!-- Chat Messages -->
        <div
            id="chat-messages"
            class="flex-1 overflow-y-auto p-3 sm:p-4 space-y-3 sm:space-y-4 scrollbar-thin scrollbar-thumb-slate-700 scrollbar-track-slate-800/50"
        >
            <!-- Welcome message -->
            <div class="flex gap-2 items-start">
                <div
                    class="w-8 h-8 bg-gradient-to-br from-cyan-400 to-purple-600 rounded-full flex items-center justify-center flex-shrink-0"
                >
                    <span class="text-sm">ğŸ¤–</span>
                </div>
                <div
                    class="bg-slate-800/80 rounded-2xl rounded-tl-none p-3 max-w-[80%] shadow-lg"
                >
                    <p class="text-sm text-slate-200">
                        {
                            lang === "es"
                                ? "Â¡Hola! ğŸ‘‹ Soy el asistente virtual. Puedo ayudarte a conocer mÃ¡s sobre mi experiencia, habilidades y proyectos. Â¿QuÃ© te gustarÃ­a saber?"
                                : "Hello! ğŸ‘‹ I'm the virtual assistant. I can help you learn more about my experience, skills, and projects. What would you like to know?"
                        }
                    </p>
                </div>
            </div>
        </div>

        <!-- Quick Actions -->
        <div id="quick-actions" class="px-3 sm:px-4 pb-2 flex flex-wrap gap-2">
            <button
                class="quick-action-btn text-xs px-3 py-1.5 bg-slate-800/80 hover:bg-slate-700 text-cyan-400 rounded-full transition-all duration-200 border border-slate-700/50 hover:border-cyan-500/50"
                data-action={lang === "es"
                    ? "Â¿CuÃ¡l es tu experiencia?"
                    : "What is your experience?"}
            >
                {lang === "es" ? "ğŸ’¼ Experiencia" : "ğŸ’¼ Experience"}
            </button>
            <button
                class="quick-action-btn text-xs px-3 py-1.5 bg-slate-800/80 hover:bg-slate-700 text-cyan-400 rounded-full transition-all duration-200 border border-slate-700/50 hover:border-cyan-500/50"
                data-action={lang === "es"
                    ? "Â¿QuÃ© tecnologÃ­as manejas?"
                    : "What technologies do you use?"}
            >
                {lang === "es" ? "ğŸ’» TecnologÃ­as" : "ğŸ’» Technologies"}
            </button>
            <button
                class="quick-action-btn text-xs px-3 py-1.5 bg-slate-800/80 hover:bg-slate-700 text-cyan-400 rounded-full transition-all duration-200 border border-slate-700/50 hover:border-cyan-500/50"
                data-action={lang === "es"
                    ? "MuÃ©strame tus proyectos"
                    : "Show me your projects"}
            >
                {lang === "es" ? "ğŸš€ Proyectos" : "ğŸš€ Projects"}
            </button>
        </div>

        <!-- Chat Input -->
        <div class="p-3 sm:p-4 border-t border-slate-700/50">
            <div class="flex gap-2">
                <input
                    type="text"
                    id="chat-input"
                    placeholder={lang === "es"
                        ? "Escribe tu pregunta..."
                        : "Type your question..."}
                    class="flex-1 bg-slate-800/80 border border-slate-700/50 rounded-xl px-3 sm:px-4 py-2 text-sm text-slate-200 placeholder-slate-500 focus:outline-none focus:border-cyan-500/50 focus:ring-2 focus:ring-cyan-500/20 transition-all"
                />
                <button
                    id="send-btn"
                    class="bg-gradient-to-r from-cyan-500 to-purple-600 hover:from-cyan-600 hover:to-purple-700 text-white rounded-xl px-3 sm:px-4 py-2 transition-all duration-200 shadow-[0_0_20px_rgba(6,182,212,0.2)] hover:shadow-[0_0_30px_rgba(6,182,212,0.4)] disabled:opacity-50 disabled:cursor-not-allowed"
                >
                    <svg
                        class="w-5 h-5"
                        fill="none"
                        stroke="currentColor"
                        viewBox="0 0 24 24"
                    >
                        <path
                            stroke-linecap="round"
                            stroke-linejoin="round"
                            stroke-width="2"
                            d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"></path>
                    </svg>
                </button>
            </div>
        </div>
    </div>
</div>

<script>
    // Chat state
    let isOpen = false;
    const chatData = {
        es: {
            experience: {
                question: /experiencia|trabajo|laboral|empleos|carrera/i,
                response: `Â¡Por supuesto! Tengo mÃ¡s de 6 aÃ±os de experiencia como desarrollador FullStack:

ğŸ¢ **Tech Solutions S.A.** (2022 - Presente)
- Senior FullStack Developer
- Liderazgo tÃ©cnico en proyectos empresariales
- Arquitecturas escalables y mentorÃ­a

ğŸ¢ **Digital Innovations** (2020 - 2022)
- Backend Developer
- APIs RESTful para fintech
- OptimizaciÃ³n de bases de datos

ğŸ¢ **StartupLab** (2018 - 2020)
- FullStack Developer
- Desarrollo web desde cero

Â¿Quieres saber mÃ¡s sobre alguna experiencia en particular?`,
            },
            technologies: {
                question:
                    /tecnologÃ­a|tecnologÃ­as|stack|herramientas|lenguajes|programaciÃ³n/i,
                response: `Manejo una amplia variedad de tecnologÃ­as modernas:

**Backend:**
- Laravel, Node.js, Python, Django

**Frontend:**
- Vue.js, React, JavaScript/TypeScript

**Bases de Datos:**
- PostgreSQL, MongoDB, Redis

**DevOps & Cloud:**
- Docker, Kubernetes, AWS, AWS Lambda

**AI & Automation:**
- OpenAI API, NLP, AutomatizaciÃ³n

Me especializo en crear soluciones completas de punta a punta. Â¿Hay alguna tecnologÃ­a especÃ­fica que te interese?`,
            },
            projects: {
                question: /proyecto|proyectos|portfolio|trabajos|aplicaciones/i,
                response: `He trabajado en diversos proyectos destacados:

ğŸš€ **Plataforma SaaS de GestiÃ³n**
- Sistema integral con microservicios
- Laravel, Vue.js, Docker

ğŸ¤– **Bot de AutomatizaciÃ³n IA**
- Procesamiento de documentos legales
- Python, OpenAI API, AWS Lambda

ğŸ’° **API Segura Fintech**
- Transacciones con alta seguridad
- Node.js, PostgreSQL, Redis

Â¿Te gustarÃ­a conocer mÃ¡s detalles de algÃºn proyecto? Â¡Navega a la secciÃ³n de proyectos para ver mÃ¡s!`,
            },
            skills: {
                question: /habilidades|skills|capacidades|conocimientos/i,
                response: `Mis principales habilidades incluyen:

âœ¨ **Desarrollo FullStack**
- Arquitecturas escalables y microservicios
- APIs RESTful de alto rendimiento

âœ¨ **AutomatizaciÃ³n IA**
- IntegraciÃ³n de IA en aplicaciones
- Procesamiento de lenguaje natural

âœ¨ **OptimizaciÃ³n**
- Rendimiento de bases de datos
- Escalabilidad de aplicaciones

âœ¨ **Liderazgo TÃ©cnico**
- MentorÃ­a de desarrolladores
- Mejores prÃ¡cticas de cÃ³digo

Â¿Hay alguna habilidad especÃ­fica que te interese conocer mÃ¡s a fondo?`,
            },
            contact: {
                question: /contacto|contactar|email|correo|hablar|contratar/i,
                response: `Â¡Me encantarÃ­a trabajar contigo! ğŸš€

Actualmente estoy disponible para nuevos proyectos y colaboraciones. Si tienes una idea que quieres llevar al siguiente nivel, hablemos.

ğŸ“§ Puedes encontrar mi informaciÃ³n de contacto en la secciÃ³n de contacto al final de la pÃ¡gina, o simplemente haz clic en el botÃ³n "Contactar" del menÃº.

Â¿Tienes alguna otra pregunta sobre mi trabajo?`,
            },
            about: {
                question: /quiÃ©n|quien|tÃº|ti|sobre ti|acerca/i,
                response: `Â¡Hola! Soy un desarrollador FullStack especializado en crear soluciones automatizadas para startups. ğŸš€

ğŸ’¡ Mi enfoque: Transformar ideas en aplicaciones escalables con automatizaciÃ³n IA.

âš¡ Mi misiÃ³n: Llevar proyectos de la idea al MVP en tiempo rÃ©cord.

ğŸ“Š EspecializaciÃ³n:
- Desarrollo FullStack
- Arquitecturas escalables
- AutomatizaciÃ³n con IA
- Soluciones para startups

Me apasiona construir aplicaciones que realmente hagan la diferencia. Â¿QuÃ© aspecto te gustarÃ­a explorar?`,
            },
            default: {
                response: `Interesante pregunta. Puedo ayudarte con informaciÃ³n sobre:

ğŸ’¼ Mi experiencia laboral
ğŸ’» Las tecnologÃ­as que manejo
ğŸš€ Mis proyectos destacados
ğŸ¯ Mis habilidades y capacidades
ğŸ“§ CÃ³mo contactarme

Â¿Sobre quÃ© te gustarÃ­a saber mÃ¡s?`,
            },
        },
        en: {
            experience: {
                question: /experience|work|job|career|employment/i,
                response: `Of course! I have over 6 years of experience as a FullStack developer:

ğŸ¢ **Tech Solutions S.A.** (2022 - Present)
- Senior FullStack Developer
- Technical leadership in enterprise projects
- Scalable architectures and mentoring

ğŸ¢ **Digital Innovations** (2020 - 2022)
- Backend Developer
- RESTful APIs for fintech
- Database optimization

ğŸ¢ **StartupLab** (2018 - 2020)
- FullStack Developer
- Web development from scratch

Would you like to know more about any particular experience?`,
            },
            technologies: {
                question:
                    /technology|technologies|tech|stack|tools|languages|programming/i,
                response: `I work with a wide variety of modern technologies:

**Backend:**
- Laravel, Node.js, Python, Django

**Frontend:**
- Vue.js, React, JavaScript/TypeScript

**Databases:**
- PostgreSQL, MongoDB, Redis

**DevOps & Cloud:**
- Docker, Kubernetes, AWS, AWS Lambda

**AI & Automation:**
- OpenAI API, NLP, Automation

I specialize in creating complete end-to-end solutions. Is there any specific technology you're interested in?`,
            },
            projects: {
                question: /project|projects|portfolio|work|applications/i,
                response: `I've worked on various featured projects:

ğŸš€ **SaaS Management Platform**
- Comprehensive system with microservices
- Laravel, Vue.js, Docker

ğŸ¤– **AI Automation Bot**
- Legal document processing
- Python, OpenAI API, AWS Lambda

ğŸ’° **Secure Fintech API**
- High-security transactions
- Node.js, PostgreSQL, Redis

Would you like to know more details about any project? Navigate to the projects section to see more!`,
            },
            skills: {
                question: /skills|abilities|capabilities|knowledge/i,
                response: `My main skills include:

âœ¨ **FullStack Development**
- Scalable architectures and microservices
- High-performance RESTful APIs

âœ¨ **AI Automation**
- AI integration in applications
- Natural language processing

âœ¨ **Optimization**
- Database performance
- Application scalability

âœ¨ **Technical Leadership**
- Developer mentoring
- Code best practices

Is there any specific skill you'd like to learn more about?`,
            },
            contact: {
                question: /contact|email|mail|talk|hire|reach/i,
                response: `I'd love to work with you! ğŸš€

I'm currently available for new projects and collaborations. If you have an idea you want to take to the next level, let's talk.

ğŸ“§ You can find my contact information in the contact section at the bottom of the page, or simply click the "Contact Me" button in the menu.

Do you have any other questions about my work?`,
            },
            about: {
                question: /who|you|about|yourself/i,
                response: `Hello! I'm a FullStack developer specialized in creating automated solutions for startups. ğŸš€

ğŸ’¡ My approach: Transforming ideas into scalable applications with AI automation.

âš¡ My mission: Taking projects from idea to MVP in record time.

ğŸ“Š Specialization:
- FullStack Development
- Scalable architectures
- AI Automation
- Startup solutions

I'm passionate about building applications that really make a difference. What aspect would you like to explore?`,
            },
            default: {
                response: `Interesting question. I can help you with information about:

ğŸ’¼ My work experience
ğŸ’» The technologies I work with
ğŸš€ My featured projects
ğŸ¯ My skills and capabilities
ğŸ“§ How to contact me

What would you like to know more about?`,
            },
        },
    };

    // Get current language from HTML lang attribute
    const currentLang = (document.documentElement.lang || "es") as "es" | "en";
    const responses = chatData[currentLang];

    // DOM Elements
    const chatToggle = document.getElementById("chat-toggle");
    const chatWindow = document.getElementById("chat-window");
    const chatMessages = document.getElementById("chat-messages");
    const chatInput = document.getElementById("chat-input") as HTMLInputElement;
    const sendBtn = document.getElementById("send-btn");
    const chatIcon = document.getElementById("chat-icon");
    const closeIcon = document.getElementById("close-icon");
    const quickActionBtns = document.querySelectorAll(".quick-action-btn");

    // Toggle chat
    function toggleChat() {
        isOpen = !isOpen;
        if (isOpen) {
            chatWindow?.classList.remove("scale-0", "opacity-0");
            chatWindow?.classList.add("scale-100", "opacity-100");
            chatIcon?.classList.add("scale-0");
            closeIcon?.classList.remove("scale-0");
            chatInput?.focus();
            // Prevent body scroll on mobile
            if (window.innerWidth < 640) {
                document.body.style.overflow = "hidden";
            }
        } else {
            chatWindow?.classList.add("scale-0", "opacity-0");
            chatWindow?.classList.remove("scale-100", "opacity-100");
            chatIcon?.classList.remove("scale-0");
            closeIcon?.classList.add("scale-0");
            // Restore body scroll
            document.body.style.overflow = "";
        }
    }

    // Add message to chat
    function addMessage(text: string, isUser: boolean) {
        const messageDiv = document.createElement("div");
        messageDiv.className = `flex gap-2 items-start ${isUser ? "justify-end" : ""}`;

        if (!isUser) {
            const avatar = document.createElement("div");
            avatar.className =
                "w-8 h-8 bg-gradient-to-br from-cyan-400 to-purple-600 rounded-full flex items-center justify-center flex-shrink-0";
            avatar.innerHTML = '<span class="text-sm">ğŸ¤–</span>';
            messageDiv.appendChild(avatar);
        }

        const bubble = document.createElement("div");
        bubble.className = `${
            isUser
                ? "bg-gradient-to-r from-cyan-500 to-purple-600"
                : "bg-slate-800/80"
        } rounded-2xl ${isUser ? "rounded-tr-none" : "rounded-tl-none"} p-3 max-w-[80%] shadow-lg`;

        const textElement = document.createElement("p");
        textElement.className = "text-sm text-slate-200 whitespace-pre-line";
        textElement.textContent = text;

        bubble.appendChild(textElement);
        messageDiv.appendChild(bubble);
        chatMessages?.appendChild(messageDiv);

        // Scroll to bottom
        chatMessages?.scrollTo({
            top: chatMessages.scrollHeight,
            behavior: "smooth",
        });
    }

    // Get bot response
    function getBotResponse(userMessage: string): string {
        const message = userMessage.toLowerCase();

        // Check each category
        for (const [key, data] of Object.entries(responses)) {
            if (
                key !== "default" &&
                "question" in data &&
                data.question &&
                data.question.test(message)
            ) {
                return data.response;
            }
        }

        return responses.default.response;
    }

    // Handle send message
    function handleSendMessage() {
        const message = chatInput?.value.trim();
        if (!message) return;

        // Add user message
        addMessage(message, true);
        chatInput!.value = "";

        // Show typing indicator
        setTimeout(() => {
            const response = getBotResponse(message);
            addMessage(response, false);
        }, 500);
    }

    // Event listeners
    chatToggle?.addEventListener("click", toggleChat);

    // Mobile close button
    const mobileCloseBtn = document.getElementById("mobile-close-btn");
    mobileCloseBtn?.addEventListener("click", toggleChat);

    sendBtn?.addEventListener("click", handleSendMessage);

    chatInput?.addEventListener("keypress", (e) => {
        if (e.key === "Enter") {
            handleSendMessage();
        }
    });

    // Quick action buttons
    quickActionBtns.forEach((btn) => {
        btn.addEventListener("click", () => {
            const action = btn.getAttribute("data-action");
            if (action) {
                addMessage(action, true);
                setTimeout(() => {
                    const response = getBotResponse(action);
                    addMessage(response, false);
                }, 500);
            }
        });
    });
</script>

<style>
    /* Custom scrollbar */
    .scrollbar-thin::-webkit-scrollbar {
        width: 6px;
    }

    .scrollbar-thin::-webkit-scrollbar-track {
        background: rgba(30, 41, 59, 0.5);
        border-radius: 10px;
    }

    .scrollbar-thin::-webkit-scrollbar-thumb {
        background: rgb(51, 65, 85);
        border-radius: 10px;
    }

    .scrollbar-thin::-webkit-scrollbar-thumb:hover {
        background: rgb(71, 85, 105);
    }

    /* Animations */
    @keyframes slideIn {
        from {
            transform: translateY(10px);
            opacity: 0;
        }
        to {
            transform: translateY(0);
            opacity: 1;
        }
    }

    #chat-messages > div {
        animation: slideIn 0.3s ease-out;
    }
</style>
