name: Deploy to Server via SSH

on:
  push:
    branches:
      - main  # Cambia a tu rama principal si es diferente
  workflow_dispatch:  # Permite ejecutar manualmente desde GitHub

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    environment:
      name: prod
      url: http://66.29.148.137
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Build project
        run: npm run build
      
      - name: Setup SSH
        run: |
          # Validar que los secrets estÃ©n configurados
          if [ -z "${{ secrets.SSH_PRIVATE_KEY }}" ]; then
            echo "âŒ ERROR: SSH_PRIVATE_KEY secret no estÃ¡ configurado"
            echo "Ve a Settings -> Secrets and variables -> Actions"
            exit 1
          fi
          
          if [ -z "${{ secrets.SSH_PUBLIC_KEY }}" ]; then
            echo "âŒ ERROR: SSH_PUBLIC_KEY secret no estÃ¡ configurado"
            echo "Ve a Settings -> Secrets and variables -> Actions"
            exit 1
          fi
          
          # Crear directorio SSH
          mkdir -p ~/.ssh
          chmod 700 ~/.ssh
          
          # Configurar llave privada
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          
          # Configurar llave pÃºblica
          echo "${{ secrets.SSH_PUBLIC_KEY }}" > ~/.ssh/id_rsa.pub
          chmod 644 ~/.ssh/id_rsa.pub
          
          # Verificar que las llaves se crearon correctamente
          if [ ! -s ~/.ssh/id_rsa ]; then
            echo "âŒ ERROR: La llave privada estÃ¡ vacÃ­a"
            exit 1
          fi
          
          echo "âœ… Llaves SSH configuradas correctamente"
          
          # AÃ±adir el host a known_hosts para evitar confirmaciÃ³n manual
          echo "ðŸ” Agregando host a known_hosts..."
          
          # Verificar conectividad primero
          echo "ðŸ” Verificando conectividad al servidor..."
          if ! ping -c 2 -W 5 66.29.148.137 > /dev/null 2>&1; then
            echo "âš ï¸  ADVERTENCIA: No se pudo hacer ping al servidor, pero continuando..."
          else
            echo "âœ… Servidor alcanzable"
          fi
          
          # Intentar ssh-keyscan con timeout y reintentos (puerto 21098)
          MAX_RETRIES=3
          RETRY_COUNT=0
          SUCCESS=false
          
          while [ $RETRY_COUNT -lt $MAX_RETRIES ] && [ "$SUCCESS" = "false" ]; do
            echo "ðŸ”„ Intento $((RETRY_COUNT + 1)) de $MAX_RETRIES..."
            
            # Usar timeout para evitar que se cuelgue indefinidamente
            if timeout 30 ssh-keyscan -T 10 -p 21098 -H 66.29.148.137 >> ~/.ssh/known_hosts 2>&1; then
              SUCCESS=true
              echo "âœ… ssh-keyscan exitoso"
            else
              RETRY_COUNT=$((RETRY_COUNT + 1))
              if [ $RETRY_COUNT -lt $MAX_RETRIES ]; then
                echo "âš ï¸  Intento fallido, esperando 5 segundos antes de reintentar..."
                sleep 5
              fi
            fi
          done
          
          if [ "$SUCCESS" = "false" ]; then
            echo "âŒ ERROR: ssh-keyscan fallÃ³ despuÃ©s de $MAX_RETRIES intentos"
            echo "ðŸ” InformaciÃ³n de depuraciÃ³n:"
            echo "  - Host: 66.29.148.137"
            echo "  - Puerto SSH: 21098"
            echo ""
            echo "ðŸ’¡ Posibles causas:"
            echo "  1. El servidor SSH no estÃ¡ corriendo en el puerto 21098"
            echo "  2. Firewall bloqueando la conexiÃ³n desde GitHub Actions"
            echo "  3. Problemas de red temporales"
            echo ""
            echo "ðŸ”§ Soluciones:"
            echo "  1. Verifica que el servidor SSH estÃ© corriendo: systemctl status sshd"
            echo "  2. Verifica el firewall: sudo ufw status"
            echo "  3. AsegÃºrate de que el puerto 21098 estÃ© abierto para conexiones externas"
            exit 1
          fi
          
          # Verificar que known_hosts tiene contenido
          if [ ! -s ~/.ssh/known_hosts ]; then
            echo "âŒ ERROR: known_hosts estÃ¡ vacÃ­o despuÃ©s de ssh-keyscan"
            exit 1
          fi
          
          echo "âœ… Host agregado a known_hosts correctamente"
          echo "âœ… Setup SSH completado"
      
      - name: Deploy via SSH
        env:
          SSH_PASSPHRASE: ${{ secrets.SSH_PASSPHRASE }}
          DEPLOY_PATH: ${{ secrets.DEPLOY_PATH }}
        run: |
          # Validar que los secrets requeridos estÃ©n configurados
          if [ -z "$DEPLOY_PATH" ]; then
            echo "âŒ ERROR: DEPLOY_PATH secret no estÃ¡ configurado"
            echo "Ve a Settings -> Secrets and variables -> Actions"
            exit 1
          fi
          
          echo "ðŸ“¦ Iniciando despliegue a $DEPLOY_PATH"
          
          # Configurar SSH agent y asegurarse de que persista
          eval $(ssh-agent -s)
          export SSH_AUTH_SOCK
          export SSH_AGENT_PID
          
          echo "ðŸ” SSH Agent PID: $SSH_AGENT_PID"
          echo "ðŸ” SSH Auth Socket: $SSH_AUTH_SOCK"
          
          # Agregar la llave al agente con passphrase
          if [ ! -z "$SSH_PASSPHRASE" ]; then
            echo "ðŸ”‘ Usando llave con passphrase"
            
            # Instalar sshpass para manejar la passphrase
            sudo apt-get update -qq
            sudo apt-get install -y -qq sshpass > /dev/null
            
            # Crear un script temporal para ssh-add
            cat > /tmp/ssh-add.sh << 'EOFSCRIPT'
#!/usr/bin/expect -f
set timeout -1
spawn ssh-add /home/runner/.ssh/id_rsa
expect "Enter passphrase"
send -- "$env(SSH_PASSPHRASE)\r"
expect eof
EOFSCRIPT
            
            chmod +x /tmp/ssh-add.sh
            
            # Instalar expect si no estÃ¡ disponible
            sudo apt-get install -y -qq expect > /dev/null
            
            # Ejecutar el script
            /tmp/ssh-add.sh
            
            # Verificar que la llave se agregÃ³
            if ! ssh-add -l | grep -q "id_rsa"; then
              echo "âŒ ERROR: No se pudo agregar la llave al agente"
              ssh-add -l
              exit 1
            fi
            
            echo "âœ… Llave agregada al agente SSH"
          else
            echo "ðŸ”‘ Usando llave sin passphrase"
            ssh-add ~/.ssh/id_rsa
          fi
          
          # Listar llaves en el agente
          echo "ðŸ” Llaves en el agente SSH:"
          ssh-add -l
          
          # Probar conexiÃ³n SSH primero
          echo "ðŸ” Probando conexiÃ³n SSH..."
          if ssh -p 21098 -o StrictHostKeyChecking=no -o BatchMode=yes ejyjaujiet@66.29.148.137 "echo 'âœ… ConexiÃ³n SSH exitosa'"; then
            echo "âœ… ConexiÃ³n SSH verificada"
          else
            echo "âŒ ERROR: No se pudo establecer conexiÃ³n SSH"
            echo "ðŸ” Intentando con mÃ¡s verbosidad..."
            ssh -p 21098 -vvv -o StrictHostKeyChecking=no ejyjaujiet@66.29.148.137 "echo 'test'" 2>&1 | tail -20
            exit 1
          fi
          
          # Sincronizar archivos del dist al servidor (usando puerto 21098)
          echo "ðŸš€ Sincronizando archivos..."
          rsync -avz --delete \
            -e "ssh -p 21098 -o StrictHostKeyChecking=no -o BatchMode=yes" \
            dist/ \
            ejyjaujiet@66.29.148.137:$DEPLOY_PATH/
          
          echo "âœ… Despliegue completado exitosamente"
      
      - name: Verify deployment
        run: |
          ssh -p 21098 -o StrictHostKeyChecking=no ejyjaujiet@66.29.148.137 "ls -la ${{ secrets.DEPLOY_PATH }}"
