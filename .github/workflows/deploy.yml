name: Deploy to Server via SSH

on:
  push:
    branches:
      - main  # Cambia a tu rama principal si es diferente
  workflow_dispatch:  # Permite ejecutar manualmente desde GitHub

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    environment:
      name: prod
      url: http://66.29.148.137
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Build project
        run: npm run build
      
      - name: Setup SSH
        run: |
          # Validar que los secrets est√©n configurados
          if [ -z "${{ secrets.SSH_PRIVATE_KEY }}" ]; then
            echo "‚ùå ERROR: SSH_PRIVATE_KEY secret no est√° configurado"
            echo "Ve a Settings -> Secrets and variables -> Actions"
            exit 1
          fi
          
          if [ -z "${{ secrets.SSH_PUBLIC_KEY }}" ]; then
            echo "‚ùå ERROR: SSH_PUBLIC_KEY secret no est√° configurado"
            echo "Ve a Settings -> Secrets and variables -> Actions"
            exit 1
          fi
          
          # Crear directorio SSH
          mkdir -p ~/.ssh
          chmod 700 ~/.ssh
          
          # Configurar llave privada
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          
          # Configurar llave p√∫blica
          echo "${{ secrets.SSH_PUBLIC_KEY }}" > ~/.ssh/id_rsa.pub
          chmod 644 ~/.ssh/id_rsa.pub
          
          # Verificar que las llaves se crearon correctamente
          if [ ! -s ~/.ssh/id_rsa ]; then
            echo "‚ùå ERROR: La llave privada est√° vac√≠a"
            exit 1
          fi
          
          echo "‚úÖ Llaves SSH configuradas correctamente"
          
          # A√±adir el host a known_hosts para evitar confirmaci√≥n manual
          echo "üîç Agregando host a known_hosts..."
          
          # Verificar conectividad primero
          echo "üîç Verificando conectividad al servidor..."
          if ! ping -c 2 -W 5 66.29.148.137 > /dev/null 2>&1; then
            echo "‚ö†Ô∏è  ADVERTENCIA: No se pudo hacer ping al servidor, pero continuando..."
          else
            echo "‚úÖ Servidor alcanzable"
          fi
          
          # Intentar ssh-keyscan con timeout y reintentos
          MAX_RETRIES=3
          RETRY_COUNT=0
          SUCCESS=false
          
          while [ $RETRY_COUNT -lt $MAX_RETRIES ] && [ "$SUCCESS" = "false" ]; do
            echo "üîÑ Intento $((RETRY_COUNT + 1)) de $MAX_RETRIES..."
            
            # Usar timeout para evitar que se cuelgue indefinidamente
            if timeout 30 ssh-keyscan -T 10 -H 66.29.148.137 >> ~/.ssh/known_hosts 2>&1; then
              SUCCESS=true
              echo "‚úÖ ssh-keyscan exitoso"
            else
              RETRY_COUNT=$((RETRY_COUNT + 1))
              if [ $RETRY_COUNT -lt $MAX_RETRIES ]; then
                echo "‚ö†Ô∏è  Intento fallido, esperando 5 segundos antes de reintentar..."
                sleep 5
              fi
            fi
          done
          
          if [ "$SUCCESS" = "false" ]; then
            echo "‚ùå ERROR: ssh-keyscan fall√≥ despu√©s de $MAX_RETRIES intentos"
            echo "üîç Informaci√≥n de depuraci√≥n:"
            echo "  - Host: 66.29.148.137"
            echo "  - Puerto SSH: 22 (por defecto)"
            echo ""
            echo "üí° Posibles causas:"
            echo "  1. El servidor SSH no est√° corriendo en el puerto 22"
            echo "  2. Firewall bloqueando la conexi√≥n desde GitHub Actions"
            echo "  3. Problemas de red temporales"
            echo ""
            echo "üîß Soluciones:"
            echo "  1. Verifica que el servidor SSH est√© corriendo: systemctl status sshd"
            echo "  2. Verifica el firewall: sudo ufw status"
            echo "  3. Aseg√∫rate de que el puerto 22 est√© abierto para conexiones externas"
            exit 1
          fi
          
          # Verificar que known_hosts tiene contenido
          if [ ! -s ~/.ssh/known_hosts ]; then
            echo "‚ùå ERROR: known_hosts est√° vac√≠o despu√©s de ssh-keyscan"
            exit 1
          fi
          
          echo "‚úÖ Host agregado a known_hosts correctamente"
          echo "‚úÖ Setup SSH completado"
      
      - name: Deploy via SSH
        env:
          SSH_PASSPHRASE: ${{ secrets.SSH_PASSPHRASE }}
          DEPLOY_PATH: ${{ secrets.DEPLOY_PATH }}
        run: |
          # Validar que los secrets requeridos est√©n configurados
          if [ -z "$DEPLOY_PATH" ]; then
            echo "‚ùå ERROR: DEPLOY_PATH secret no est√° configurado"
            echo "Ve a Settings -> Secrets and variables -> Actions"
            exit 1
          fi
          
          echo "üì¶ Iniciando despliegue a $DEPLOY_PATH"
          
          # Configurar SSH agent
          eval $(ssh-agent -s)
          
          # Agregar la llave al agente
          if [ ! -z "$SSH_PASSPHRASE" ]; then
            echo "üîë Usando llave con passphrase"
            # Instalar expect para manejar la passphrase
            sudo apt-get update -qq
            sudo apt-get install -y -qq expect > /dev/null
            
            # Usar expect para agregar la llave con passphrase
            expect -c "
              spawn ssh-add ~/.ssh/id_rsa
              expect \"Enter passphrase\"
              send \"$SSH_PASSPHRASE\r\"
              expect eof
            "
          else
            echo "üîë Usando llave sin passphrase"
            ssh-add ~/.ssh/id_rsa
          fi
          
          echo "‚úÖ Llave SSH agregada al agente"
          
          # Crear directorio remoto si no existe
          echo "üìÅ Verificando/creando directorio remoto..."
          ssh -o StrictHostKeyChecking=no ejyjaujiet@66.29.148.137 "mkdir -p $DEPLOY_PATH"
          
          # Sincronizar archivos del dist al servidor
          echo "üöÄ Sincronizando archivos..."
          rsync -avz --delete \
            -e "ssh -o StrictHostKeyChecking=no" \
            dist/ \
            ejyjaujiet@66.29.148.137:$DEPLOY_PATH/
          
          echo "‚úÖ Despliegue completado exitosamente"
      
      - name: Verify deployment
        run: |
          ssh -o StrictHostKeyChecking=no ejyjaujiet@66.29.148.137 "ls -la ${{ secrets.DEPLOY_PATH }}"
