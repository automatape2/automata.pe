name: Deploy to Server via SSH

on:
  push:
    branches:
      - main  # Cambia a tu rama principal si es diferente
  workflow_dispatch:  # Permite ejecutar manualmente desde GitHub

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    environment:
      name: prod
      url: http://66.29.148.137
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Build project
        run: npm run build
      
      - name: Setup SSH
        run: |
          # Validar que los secrets estÃ©n configurados
          if [ -z "${{ secrets.SSH_PRIVATE_KEY }}" ]; then
            echo "âŒ ERROR: SSH_PRIVATE_KEY secret no estÃ¡ configurado"
            echo "Ve a Settings -> Secrets and variables -> Actions"
            exit 1
          fi
          
          if [ -z "${{ secrets.SSH_PUBLIC_KEY }}" ]; then
            echo "âŒ ERROR: SSH_PUBLIC_KEY secret no estÃ¡ configurado"
            echo "Ve a Settings -> Secrets and variables -> Actions"
            exit 1
          fi
          
          # Crear directorio SSH
          mkdir -p ~/.ssh
          chmod 700 ~/.ssh
          
          # Configurar llave privada
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          
          # Configurar llave pÃºblica
          echo "${{ secrets.SSH_PUBLIC_KEY }}" > ~/.ssh/id_rsa.pub
          chmod 644 ~/.ssh/id_rsa.pub
          
          # Verificar que las llaves se crearon correctamente
          if [ ! -s ~/.ssh/id_rsa ]; then
            echo "âŒ ERROR: La llave privada estÃ¡ vacÃ­a"
            exit 1
          fi
          
          echo "âœ… Llaves SSH configuradas correctamente"
          
          # AÃ±adir el host a known_hosts para evitar confirmaciÃ³n manual
          echo "ðŸ” Agregando host a known_hosts..."
          ssh-keyscan -H 66.29.148.137 >> ~/.ssh/known_hosts 2>&1
          
          echo "âœ… Setup SSH completado"
      
      - name: Deploy via SSH
        env:
          SSH_PASSPHRASE: ${{ secrets.SSH_PASSPHRASE }}
          DEPLOY_PATH: ${{ secrets.DEPLOY_PATH }}
        run: |
          # Validar que los secrets requeridos estÃ©n configurados
          if [ -z "$DEPLOY_PATH" ]; then
            echo "âŒ ERROR: DEPLOY_PATH secret no estÃ¡ configurado"
            echo "Ve a Settings -> Secrets and variables -> Actions"
            exit 1
          fi
          
          echo "ðŸ“¦ Iniciando despliegue a $DEPLOY_PATH"
          
          # Configurar SSH agent
          eval $(ssh-agent -s)
          
          # Agregar la llave al agente
          if [ ! -z "$SSH_PASSPHRASE" ]; then
            echo "ðŸ”‘ Usando llave con passphrase"
            # Instalar expect para manejar la passphrase
            sudo apt-get update -qq
            sudo apt-get install -y -qq expect > /dev/null
            
            # Usar expect para agregar la llave con passphrase
            expect << EOF
              spawn ssh-add ~/.ssh/id_rsa
              expect "Enter passphrase"
              send "$SSH_PASSPHRASE\r"
              expect eof
          EOF
          else
            echo "ðŸ”‘ Usando llave sin passphrase"
            ssh-add ~/.ssh/id_rsa
          fi
          
          echo "âœ… Llave SSH agregada al agente"
          
          # Crear directorio remoto si no existe
          echo "ðŸ“ Verificando/creando directorio remoto..."
          ssh -o StrictHostKeyChecking=no ejyjaujiet@66.29.148.137 "mkdir -p $DEPLOY_PATH"
          
          # Sincronizar archivos del dist al servidor
          echo "ðŸš€ Sincronizando archivos..."
          rsync -avz --delete \
            -e "ssh -o StrictHostKeyChecking=no" \
            dist/ \
            ejyjaujiet@66.29.148.137:$DEPLOY_PATH/
          
          echo "âœ… Despliegue completado exitosamente"
      
      - name: Verify deployment
        run: |
          ssh -o StrictHostKeyChecking=no ejyjaujiet@66.29.148.137 "ls -la ${{ secrets.DEPLOY_PATH }}"
